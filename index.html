<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>The Blog</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

  <style>
    /* --- CHRISTMAS THEME VARIABLES ðŸŽ„ --- */
    :root {
      /* Base Colors */
      --bg: #e3f2fd;
      --primary: #D62828; /* Christmas Red */
      --secondary: #008000; /* Holly Green */
      --text: #2c3e50;
      --muted: #7f8c8d;
      
      /* Component Colors */
      --card-bg: rgba(255, 255, 255, 0.85);
      --radius: 18px;
      --shadow: 0 4px 25px rgba(0, 0, 0, 0.1);
      --blur-bg: rgba(255, 255, 255, 0.6);
      --blur: blur(15px);
      --red-delete: #ff3b30; 
      
      /* New iOS Popup Variables */
      --ios-dialog-bg: rgba(255, 255, 255, 0.95);
      --ios-dialog-radius: 14px;
      --ios-button-border: 1px solid rgba(186, 186, 186, 0.5);
      
      /* iOS List Group Variables */
      --ios-group-bg: #fff;
      --ios-item-border: 1px solid #e5e5e5;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
      min-height: 100vh;
      overscroll-behavior-y: none;
      overflow-x: hidden;
      background-image: url('ChristmasBG.png'); /* Placeholder */
      background-size: cover; 
      background-attachment: fixed;
      background-position: center center;
    }

    #app-container {
        width: 100%;
        max-width: 450px; 
        margin: 0 auto;
        min-height: 100vh;
        background-color: rgba(255, 255, 255, 0.2); 
        box-shadow: 0 0 30px rgba(0,0,0,0.1);
        position: relative;
        padding-bottom: 80px;
        overflow: hidden;
    }

    header {
      text-align: center;
      font-size: 1.3rem;
      font-weight: 600;
      padding: 1rem;
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: var(--blur);
      background: var(--blur-bg);
      border-bottom: 1px solid rgba(44, 62, 80, 0.1);
    }
    
    header i { color: var(--secondary); margin-right: 5px; }

    main { max-width: 700px; margin: auto; padding: 1rem; }
    .hidden { display: none !important; }

    button {
      border: none;
      border-radius: var(--radius);
      padding: 0.8rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      background: var(--primary);
      color: white;
      transition: 0.2s;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
    }

    button:active { transform: scale(0.98); }

    .btn-delete { background: var(--red-delete); color: white; border: none; }
    .btn-delete:active { background: #cc0000; }
    
    .btn-text { background: transparent; color: var(--muted); padding: 5px 10px; font-size: 0.9rem; }
    .btn-text:hover { color: var(--text); background: rgba(0,0,0,0.05); }

    .post {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1.2rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow);
      backdrop-filter: var(--blur);
      cursor: pointer;
      transition: transform 0.15s;
      user-select: none;
      border: 1px solid rgba(214, 40, 40, 0.1);
    }

    .post:active { transform: scale(0.98); }
    
    .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    
    .post-avatar {
        width: 35px; height: 35px;
        background-color: var(--secondary);
        color: white; border-radius: 50%;
        display: flex; justify-content: center; align-items: center;
        font-size: 14px; font-weight: 600; flex-shrink: 0;
    }
    
    .post-owner-info { flex-grow: 1; line-height: 1.2; }
    .post h2 { margin: 0; font-size: 1.15rem; font-weight: 600; }
    .post small { color: var(--muted); display: block; margin-top: 2px; font-size: 0.85rem; }
    
    .post-owner-name { font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
    
    .verified-badge { width: 16px; height: 16px; object-fit: contain; flex-shrink: 0; }

    .post-content-preview {
        font-size: 0.95rem; color: var(--muted); margin-top: 0.5rem;
        overflow: hidden; text-overflow: ellipsis; display: -webkit-box;
        -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    }

    form {
      display: flex; flex-direction: column; gap: 1rem;
      background: var(--card-bg); padding: 1.5rem;
      border-radius: var(--radius); box-shadow: var(--shadow);
      backdrop-filter: var(--blur); border: 1px solid rgba(214, 40, 40, 0.1);
    }

    input, textarea {
      padding: 0.8rem; border-radius: 12px; border: 1px solid #ccc;
      font-size: 1rem; font-family: 'Poppins', sans-serif; width: 100%;
    }
    
    input:focus, textarea:focus {
        border-color: var(--primary); box-shadow: 0 0 0 3px rgba(214, 40, 40, 0.2); outline: none;
    }

    textarea { resize: vertical; height: 150px; }

    nav {
      position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
      width: 100%; max-width: 450px; display: flex;
      justify-content: space-around; align-items: center;
      padding: 0.6rem 0.5rem; backdrop-filter: var(--blur);
      background: var(--blur-bg); border-top: 1px solid rgba(44, 62, 80, 0.1);
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 20;
    }

    nav button {
      background: none; color: var(--muted); font-size: 0.9rem; border: none;
      display: flex; flex-direction: column; align-items: center;
      gap: 0.25rem; padding: 0.5rem 1rem; min-width: 60px;
    }

    nav button i { font-size: 1.2rem; }
    nav button.active { color: var(--primary); font-weight: 600; }

    #searchBar { width: 100%; padding: 0.8rem 1rem; border-radius: var(--radius); border: 1px solid #ccc; margin-bottom: 1rem; font-size: 1rem; }

    .detail-card {
        background: var(--card-bg); border-radius: var(--radius);
        padding: 1.5rem; margin-bottom: 1rem; box-shadow: var(--shadow);
        backdrop-filter: var(--blur); border: 1px solid rgba(214, 40, 40, 0.1);
    }

    .view-title { font-size: 1.6rem; font-weight: 700; margin-bottom: 0.5rem; margin-top: 0; }
    .view-content { margin-top: 1rem; line-height: 1.7; font-size: 1.05rem; white-space: pre-wrap; word-wrap: break-word; }
    .action-row { display: flex; justify-content: flex-start; margin-top: 2rem; gap: 1rem; }
    
    .reaction-bar { display: flex; justify-content: flex-start; gap: 15px; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0, 0, 0, 0.05); }
    .reaction-button {
        display: flex; align-items: center; gap: 5px; font-size: 0.9rem;
        color: var(--muted); cursor: pointer; transition: color 0.1s, transform 0.1s;
        font-weight: 500; user-select: none;
    }
    
    .reaction-button:active { transform: scale(0.95); }
    .reaction-button.liked { color: var(--primary); }
    .reaction-button.disliked { color: var(--secondary); }

    /* --- COMMENT SECTION STYLES --- */
    #commentsSection {
        margin-top: 20px;
        padding-bottom: 50px;
    }

    #addCommentContainer {
        display: flex; gap: 10px; margin-bottom: 20px;
    }
    
    #addCommentInput { flex-grow: 1; padding: 10px; height: 45px; }
    #addCommentBtn { padding: 0 15px; height: 45px; display: flex; align-items: center; justify-content: center; }

    .comment-tree { display: flex; flex-direction: column; gap: 10px; }

    .comment-node {
        background: rgba(255,255,255,0.7);
        border-radius: 12px;
        padding: 10px;
        position: relative;
        border: 1px solid rgba(0,0,0,0.05);
    }

    .comment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .comment-author { font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; }
    .comment-time { font-size: 0.7rem; color: var(--muted); }
    .comment-body { font-size: 0.95rem; line-height: 1.4; white-space: pre-wrap; word-break: break-word; color: #333; }
    
    .comment-actions {
        display: flex; gap: 15px; margin-top: 8px; align-items: center;
    }
    
    .comment-action-btn { font-size: 0.8rem; color: var(--muted); cursor: pointer; display: flex; align-items: center; gap: 4px; }
    .comment-action-btn:hover { color: var(--primary); }
    .comment-action-btn.liked { color: var(--primary); }
    
    /* Replies */
    .replies-container {
        margin-left: 15px; /* Indentation */
        padding-left: 10px;
        border-left: 2px solid rgba(214, 40, 40, 0.2); /* Thread line */
        margin-top: 10px;
        display: flex; flex-direction: column; gap: 10px;
    }

    .reply-form {
        margin-top: 10px; display: flex; gap: 5px;
        animation: fadeIn 0.2s ease;
    }
    .reply-form input { padding: 8px; font-size: 0.9rem; }
    .reply-form button { padding: 8px 12px; font-size: 0.8rem; }

    /* --- IOS POPUP STYLES --- */
    #popupOverlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none;
      justify-content: center; align-items: center; z-index: 100; animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn { from { opacity: 0 } to { opacity: 1 } }

    #popup {
      width: 90%; max-width: 270px; background: var(--ios-dialog-bg);
      border-radius: var(--ios-dialog-radius); text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2); overflow: hidden;
      animation: slideIn 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); backdrop-filter: var(--blur);
    }

    @keyframes slideIn { from { transform: scale(1.1); opacity: 0 } to { transform: scale(1); opacity: 1 } }

    #popup h3 { margin: 0; padding: 20px 15px 0; font-weight: 600; font-size: 17px; line-height: 1.3;}
    #popup p { margin: 0; padding: 5px 15px 20px; color: #333; font-weight: 400; font-size: 13px; line-height: 1.3;}
    #popup input { margin: 0 15px 15px; padding: 10px; font-size: 15px; border-radius: 8px; border: 1px solid #ccc; text-align: center;}

    #popup .button-holder { border-top: var(--ios-button-border); }
    #popup .button-holder a {
      color: var(--primary); text-decoration: none; height: 44px; line-height: 44px;
      font-weight: 400; display: block; cursor: pointer; transition: background-color 0.1s; user-select: none;
    }
    #popup .button-holder a:active { background-color: rgba(0, 0, 0, 0.1); }
    #popup .two-button { display: flex; width: 100%; }
    #popup .two-button a { flex: 1; border-top: none; }
    #popup .two-button a:first-child { border-right: var(--ios-button-border); }
    #popup .two-button a:last-child { color: var(--primary); font-weight: 600; }
    #popup .vertical-buttons a:not(:last-child) { border-bottom: var(--ios-button-border); }
    #popup .vertical-buttons a:first-child { font-weight: 600; }
    #popup .vertical-buttons a.delete-button { color: var(--red-delete); font-weight: 600; }

    .empty-state { text-align: center; color: var(--muted); padding: 30px 0; }

    /* --- PROFILE PAGE STYLES --- */
    #profilePage h2 { font-size: 1.6rem; font-weight: 700; margin-bottom: 0.5rem; padding-left: 1rem; }
    .profile-header { text-align: center; padding: 1rem 0 2rem; }
    
    .profile-avatar-large {
        width: 80px; height: 80px; background-color: var(--primary); color: white;
        border-radius: 50%; display: inline-flex; justify-content: center; align-items: center;
        font-size: 36px; font-weight: 600; margin-bottom: 10px;
    }
    
    .profile-display-name { font-size: 1.4rem; font-weight: 700; display: flex; justify-content: center; align-items: center; gap: 8px; }
    .profile-display-name .verified-badge { width: 22px; height: 22px; }
    
    .ios-list-group { background: var(--ios-group-bg); border-radius: 10px; margin: 1rem 0; overflow: hidden; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.05); }

    .list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.9rem 1rem; border-top: var(--ios-item-border); cursor: pointer; transition: background-color 0.1s; }
    .list-item:first-child { border-top: none; }
    .list-item:active { background-color: #f0f0f0; }
    
    .list-item-content { display: flex; align-items: center; gap: 10px; font-weight: 500; }
    .list-item-icon { width: 30px; height: 30px; border-radius: 6px; display: flex; justify-content: center; align-items: center; color: white; font-size: 16px; }

    .icon-blue { background-color: var(--primary); }
    .icon-red { background-color: var(--red-delete); }
    .icon-green { background-color: var(--secondary); }
    .icon-gray { background-color: #8e8e93; color: white; }

    .list-item-value { color: var(--muted); font-weight: 400; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
    .list-item-arrow { color: #c7c7cc; font-size: 16px; }

    /* --- BOTTOM SHEET STYLES --- */
    .bottom-sheet-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.4); z-index: 150; display: none; opacity: 0; transition: opacity 0.3s ease;
    }
    .bottom-sheet-overlay.open { display: block; opacity: 1; }
    
    .bottom-sheet {
        position: fixed; bottom: 0; left: 0; right: 0;
        background: var(--card-bg); border-radius: 24px 24px 0 0;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.15); z-index: 151;
        height: 85vh; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        max-width: 450px; margin: 0 auto; backdrop-filter: var(--blur);
    }
    .bottom-sheet.open { transform: translateY(0); }
    
    .sheet-header { height: 40px; display: flex; justify-content: center; align-items: center; cursor: grab; }
    .drag-handle { width: 40px; height: 5px; background: var(--muted); border-radius: 10px; }

    .sheet-content { padding: 0 25px 80px 25px; overflow-y: auto; height: calc(85vh - 40px); -webkit-overflow-scrolling: touch; }
    .sheet-content h2 { margin-top: 0; font-size: 1.4rem; }
    .sheet-content h3 { font-size: 1.1rem; margin-bottom: 5px; margin-top: 20px; font-weight: 600; color: #333; }
    .sheet-content h4 { font-size: 1rem; margin-bottom: 5px; margin-top: 15px; font-weight: 600; color: #555; }
    .sheet-content p, .sheet-content li { color: var(--text); font-size: 0.9rem; line-height: 1.6; margin-bottom: 10px;}
    .sheet-content ul { padding-left: 20px; }

    @media (max-width: 600px) {
      header { font-size: 1.1rem; padding: 0.8rem; }
      .post { padding: 1rem; }
      button { font-size: 0.95rem; padding: 0.7rem; }
      textarea { height: 120px; }
      main { padding: 1rem; }
      nav { padding: 0.6rem 0.2rem; }
    }
  </style>
</head>
<body>
<div id="app-container">
    <header><i class="fa-solid fa-gift"></i> The Blog</header> <main>
        <section id="homePage">
            <input type="text" id="searchBar" placeholder="Search posts..." />
            <div id="postsContainer">
                <div class="empty-state"><i class="fa-solid fa-spinner fa-spin"></i> Loading posts...</div>
            </div>
        </section>

        <section id="newPostPage" class="hidden">
            <form id="postForm">
                <input type="text" id="title" placeholder="Title" required />
                <textarea id="content" placeholder="Write something..." required></textarea>
                <button type="submit"><i class="fa-solid fa-star"></i> Publish</button> </form>
        </section>

        <section id="viewPostPage" class="hidden">
            <div class="detail-card">
                <div id="viewPost"></div>
                <div class="action-row"></div>
                 <div id="detailReactions" class="reaction-bar" style="border-top: none;"></div>
                <small id="postOwnerInfo" style="display: block; margin-top: 15px; color: #aaa;"></small>
            </div>
            
            <div id="commentsSection">
                <h3 style="margin-left: 5px; margin-bottom: 15px;">Comments</h3>
                <div id="addCommentContainer">
                    <input type="text" id="addCommentInput" placeholder="Add a comment...">
                    <button id="addCommentBtn"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
                <div id="commentsList" class="comment-tree">
                    </div>
            </div>
        </section>
        
        <section id="profilePage" class="hidden">
            <div class="profile-header">
                <div id="profileAvatarLarge" class="profile-avatar-large">U</div>
                <div id="profileDisplayName" class="profile-display-name">
                    Default User
                </div>
                <small style="color: var(--muted);">User ID: <span id="profileUserId">Loading...</span></small>
            </div>
            
            <div class="ios-list-group">
                <div class="list-item" id="changeNameBtn">
                    <div class="list-item-content">
                        <div class="list-item-icon icon-blue"><i class="fa-solid fa-user-tag"></i></div>
                        <span>Display Name</span>
                    </div>
                    <div class="list-item-value" id="currentNameValue">Default User <i class="fa-solid fa-chevron-right list-item-arrow"></i></div>
                </div>
                
                <div class="list-item" id="verifyBtn">
                    <div class="list-item-content">
                        <div class="list-item-icon icon-green"><i class="fa-solid fa-badge-check"></i></div>
                        <span>Dark Verifiedâ„¢ Status</span>
                    </div>
                    <div class="list-item-value" id="verifyStatusValue">Unverified <i class="fa-solid fa-chevron-right list-item-arrow"></i></div>
                </div>
            </div>
            
            <div class="ios-list-group" id="adminGroup">
                 <div class="list-item" id="adminAccessBtn">
                    <div class="list-item-content">
                        <div class="list-item-icon icon-red"><i class="fa-solid fa-key"></i></div>
                        <span>Access Dark Admin</span>
                    </div>
                    <div class="list-item-value"><i class="fa-solid fa-chevron-right list-item-arrow"></i></div>
                </div>
                
                <div class="list-item hidden" id="generateKeyBtn">
                    <div class="list-item-content">
                        <div class="list-item-icon icon-gray"><i class="fa-solid fa-lock-keyhole"></i></div>
                        <span>Generate Verify Key</span>
                    </div>
                    <div class="list-item-value"><i class="fa-solid fa-chevron-right list-item-arrow"></i></div>
                </div>
            </div>
        </section>
    </main>

    <nav>
        <button id="homeBtn" class="active"><i class="fa-solid fa-sleigh"></i><span>Home</span></button> 
        <button id="newBtn"><i class="fa-solid fa-candy-cane"></i><span>New</span></button> 
        <button id="profileBtn"><i class="fa-solid fa-user"></i><span>Profile</span></button> 
        <button id="privacyBtn"><i class="fa-solid fa-shield-halved"></i><span>Privacy</span></button> 
    </nav>

    <div id="popupOverlay">
        <div id="popup">
            <h3 id="popupTitle">Title</h3>
            <p id="popupMessage">Message</p>
            <div id="popupButtons"></div>
        </div>
    </div>

    <div class="bottom-sheet-overlay" id="sheetOverlay"></div>
    <div class="bottom-sheet" id="privacySheet">
        <div class="sheet-header" id="sheetDragArea">
            <div class="drag-handle"></div>
        </div>
        <div class="sheet-content">
            <h2 style="text-align: center; margin-bottom: 20px;">Privacy Policy & Terms of Service</h2>
            <p style="text-align: center; color: var(--muted);">Last Updated: November 27, 2025</p>
            
            <h3>1. Introduction</h3>
            <p>Welcome to "The Blog" (hereinafter referred to as "the Service"), provided by Dark ("we," "us," or "our"). By accessing or using our Service, you agree to be bound by these Terms of Service and our Privacy Policy.</p>
            
            <h3>2. Information We Collect</h3>
            <p>We collect different types of information for various purposes to provide and improve our Service to you.</p>
            <h4>A. Personal Data</h4>
            <p>While using our Service, we may ask you to provide us with certain personally identifiable information that can be used to contact or identify you ("Personal Data"). This may include, but is not limited to:</p>
            <ul>
                <li>Display Names and User Profiles</li>
                <li>Cookies and Usage Data</li>
                <li>User Generated Content (Posts and Comments)</li>
            </ul>
            
            <h4>B. Usage Data</h4>
            <p>We may also collect information on how the Service is accessed and used ("Usage Data"). This Usage Data may include information such as your computer's Internet Protocol address (e.g. IP address), browser type, browser version, the pages of our Service that you visit, the time and date of your visit, the time spent on those pages, unique device identifiers and other diagnostic data.</p>

            <h3>3. Cookies and Tracking Technologies</h3>
            <p>We use cookies and similar tracking technologies to track the activity on our Service and hold certain information.</p>
            <h4>Google AdSense & DoubleClick Cookie</h4>
            <p>Google, as a third-party vendor, uses cookies to serve ads on our Service.</p>
            <ul>
                <li>Google's use of the DART cookie enables it and its partners to serve ads to our users based on their visit to our Service or other sites on the Internet.</li>
                <li>You may opt out of the use of the DART cookie by visiting the Google Ad Settings web page.</li>
            </ul>
            
            <h3>4. How We Use Your Data</h3>
            <p>Dark uses the collected data for various purposes:</p>
            <ul>
                <li>To provide and maintain the Service</li>
                <li>To notify you about changes to our Service</li>
                <li>To allow you to participate in interactive features of our Service (Commenting, Posting, Liking)</li>
                <li>To provide customer care and support</li>
                <li>To provide analysis or valuable information so that we can improve the Service</li>
                <li>To monitor the usage of the Service</li>
                <li>To detect, prevent and address technical issues</li>
            </ul>

            <h3>5. Content Guidelines & Terms of Use</h3>
            <p>By using this Service, you agree not to post content that is:</p>
            <ul>
                <li>Illegal, harmful, threatening, abusive, harassing, defamatory, vulgar, obscene, or invasive of another's privacy.</li>
                <li>Hateful regarding race, ethnicity, gender, or religion.</li>
                <li>Spam, phishing, or unsolicited commercial advertising.</li>
            </ul>
            <p><strong>Termination:</strong> We reserve the right to terminate or suspend access to our Service immediately, without prior notice or liability, for any reason whatsoever, including without limitation if you breach the Terms.</p>

            <h3>6. Data Retention</h3>
            <p>We will retain your Personal Data only for as long as is necessary for the purposes set out in this Privacy Policy. We will retain and use your Personal Data to the extent necessary to comply with our legal obligations, resolve disputes, and enforce our legal agreements and policies. Content deleted by users is removed from our live database but may persist in backups for a limited period.</p>

            <h3>7. Security of Data</h3>
            <p>The security of your data is important to us, but remember that no method of transmission over the Internet, or method of electronic storage is 100% secure. While we strive to use commercially acceptable means to protect your Personal Data, we cannot guarantee its absolute security.</p>

            <h3>8. Your Data Protection Rights</h3>
            <p>Depending on your location, you may have rights under the GDPR (General Data Protection Regulation) or CCPA (California Consumer Privacy Act).</p>
            <ul>
                <li><strong>The right to access, update or to delete</strong> the information we have on you.</li>
                <li><strong>The right of rectification.</strong> You have the right to have your information rectified if that information is inaccurate or incomplete.</li>
                <li><strong>The right to object.</strong> You have the right to object to our processing of your Personal Data.</li>
                <li><strong>The right of restriction.</strong> You have the right to request that we restrict the processing of your personal information.</li>
            </ul>
            
            <h3>9. Links to Other Sites</h3>
            <p>Our Service may contain links to other sites that are not operated by us. If you click on a third party link, you will be directed to that third party's site. We strongly advise you to review the Privacy Policy of every site you visit.</p>

            <h3>10. Changes to This Policy</h3>
            <p>We may update our Privacy Policy from time to time. We will notify you of any changes by posting the new Privacy Policy on this page. You are advised to review this Privacy Policy periodically for any changes.</p>

            <h3>11. Contact Us</h3>
            <p>If you have any questions about this Privacy Policy, please contact us:</p>
            <p><strong>Email:</strong> <a href="mailto:Sersever35@proton.me" style="color:var(--primary); text-decoration: none; font-weight: 600;">Sersever35@proton.me</a></p>
            <br><br><br>
        </div>
    </div>

</div>
  <script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, collection, addDoc, updateDoc, onSnapshot, doc, query, deleteDoc, serverTimestamp, setLogLevel, getDoc, setDoc, where, writeBatch, getDocs
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Firebase Config ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    const userProvidedConfig = {
        apiKey: "AIzaSyBiDjwSktDSEdomaRnbfl1UcvCgihhWH1A",
        projectId: "themoreinfoblog",
    };
    const canvasConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const firebaseConfig = { ...userProvidedConfig, ...canvasConfig };
    
    const POSTS_COLLECTION_PATH = `/artifacts/${appId}/public/data/posts`;
    const USERS_COLLECTION_PATH = `/artifacts/${appId}/public/data/users`;
    const COMMENTS_COLLECTION_PATH = `/artifacts/${appId}/public/data/comments`;
    const ADMIN_KEY_DOC_PATH = `/artifacts/${appId}/public/data/admin/verifyKey`;

    let app, db, auth;
    let isAuthReady = false;
    let currentUserId = null; 
    let currentPostsData = {}; 
    let currentKey = null; // Currently open post ID
    let commentsUnsubscribe = null; // To stop listening when leaving post
    
    // --- NEW PROFILE STATE ---
    let currentUserName = "Dark User";
    let isDarkVerified = false;
    let isAdmin = false;

    // --- ADMIN KEY CONSTANT ---
    const ADMIN_PASSKEY = "9VJZxFKQhqkDrZXerdFfryKdwZ9AMrr5"; 
    const VERIFIED_BADGE_URL = "https://i.ibb.co/WNnTJDFY/verified-badge-profile-icon-png.png";

    // --- DOM Elements ---
    const pages = {
        home: document.getElementById('homePage'),
        newPost: document.getElementById('newPostPage'),
        viewPost: document.getElementById('viewPostPage'),
        profile: document.getElementById('profilePage'),
    };
    const postsContainer = document.getElementById('postsContainer');
    const postForm = document.getElementById('postForm');
    const searchBar = document.getElementById('searchBar');
    const homeBtn = document.getElementById('homeBtn');
    const newBtn = document.getElementById('newBtn');
    const profileBtn = document.getElementById('profileBtn');
    const privacyBtn = document.getElementById('privacyBtn');
    
    const viewPost = document.getElementById('viewPost');
    const actionRow = document.querySelector('#viewPostPage .action-row');
    const detailReactionsContainer = document.getElementById('detailReactions');
    const postOwnerInfo = document.getElementById('postOwnerInfo');

    const popupOverlay = document.getElementById('popupOverlay');
    const popupTitle = document.getElementById('popupTitle');
    const popupMessage = document.getElementById('popupMessage');
    const popupButtons = document.getElementById('popupButtons');
    
    // Comment Elements
    const commentsList = document.getElementById('commentsList');
    const addCommentInput = document.getElementById('addCommentInput');
    const addCommentBtn = document.getElementById('addCommentBtn');

    // --- Profile Page Elements ---
    const profileAvatarLarge = document.getElementById('profileAvatarLarge');
    const profileDisplayName = document.getElementById('profileDisplayName');
    const profileUserId = document.getElementById('profileUserId');
    const currentNameValue = document.getElementById('currentNameValue');
    const verifyStatusValue = document.getElementById('verifyStatusValue');
    const changeNameBtn = document.getElementById('changeNameBtn');
    const verifyBtn = document.getElementById('verifyBtn');
    const adminAccessBtn = document.getElementById('adminAccessBtn');
    const generateKeyBtn = document.getElementById('generateKeyBtn');
    const adminGroup = document.getElementById('adminGroup');

    // --- Privacy Sheet Elements ---
    const sheetOverlay = document.getElementById('sheetOverlay');
    const privacySheet = document.getElementById('privacySheet');
    const sheetDragArea = document.getElementById('sheetDragArea');

    // --- Helper Functions ---
    function getInitials(name) {
        if (!name) return 'U';
        const parts = name.split(' ').filter(p => p.length > 0);
        if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
        return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
    }
    
    function getVerifiedBadge(isLarge = false) {
        if (!isDarkVerified && !isLarge) return '';
        const imageClass = 'verified-badge';
        return `<img src="${VERIFIED_BADGE_URL}" class="${imageClass}" title="Dark Verifiedâ„¢">`;
    }
    
    function getPostOwnerName(postOrComment) {
        const name = postOrComment.userName || 'Dark User';
        const isVerified = postOrComment.isVerified || false;
        const verifiedBadgeHtml = isVerified ? `<img src="${VERIFIED_BADGE_URL}" class="verified-badge" title="Dark Verifiedâ„¢">` : '';
        return `<span class="post-owner-name">${name}${verifiedBadgeHtml}</span>`;
    }
    
    function formatTime(date) {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }
    
    // --- Profile Update Logic ---
    function updateProfileUI() {
        profileAvatarLarge.textContent = getInitials(currentUserName);
        profileDisplayName.innerHTML = `${currentUserName} ${isDarkVerified ? `<img src="${VERIFIED_BADGE_URL}" class="verified-badge" title="Dark Verifiedâ„¢">` : ''}`;
        profileUserId.textContent = currentUserId ? currentUserId.substr(0, 10) + '...' : 'N/A';
        currentNameValue.innerHTML = `${currentUserName} <i class="fa-solid fa-chevron-right list-item-arrow"></i>`;
        
        verifyStatusValue.innerHTML = isDarkVerified 
            ? `Verified ${getVerifiedBadge(true)} <i class="fa-solid fa-chevron-right list-item-arrow"></i>`
            : `Unverified <i class="fa-solid fa-chevron-right list-item-arrow"></i>`;
            
        adminAccessBtn.classList.toggle('hidden', isAdmin);
        generateKeyBtn.classList.toggle('hidden', !isAdmin);
        if (!isAdmin && document.querySelectorAll('#adminGroup > .list-item:not(.hidden)').length === 0) {
            adminGroup.style.display = 'none';
        } else {
            adminGroup.style.display = 'block';
        }

        if (!pages.home.classList.contains('hidden')) {
            displayPosts(Object.values(currentPostsData), searchBar.value);
        }
    }
    
    async function fetchUserProfile() {
        if (!currentUserId) return;
        try {
            const userDocRef = doc(db, USERS_COLLECTION_PATH, currentUserId);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                const data = userDoc.data();
                currentUserName = data.userName || "Dark User";
                isDarkVerified = data.isVerified || false;
                isAdmin = data.isAdmin || false;
            } else {
                await setDoc(userDocRef, { 
                    userName: currentUserName, isVerified: isDarkVerified, isAdmin: isAdmin, createdAt: serverTimestamp() 
                });
            }
            updateProfileUI();
        } catch (error) { console.error("Error fetching profile:", error); }
    }
    
    async function updateUserName(newName) {
        if (!currentUserId) return;
        try {
            await updateDoc(doc(db, USERS_COLLECTION_PATH, currentUserId), { userName: newName });
            currentUserName = newName;
            updateProfileUI();
            return true;
        } catch (error) { return false; }
    }
    
    // --- Admin/Verification Key Logic ---
    function generateKey(length = 32) {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
        return result;
    }
    
    async function saveVerificationKey() {
        if (!isAdmin) return;
        const newKey = generateKey(16);
        const expiry = Date.now() + (5 * 60 * 1000); 
        try {
            await setDoc(doc(db, ADMIN_KEY_DOC_PATH), { key: newKey, expires: expiry, generatedAt: serverTimestamp() });
            showPopup("Verification Key Generated", `Key: **${newKey}** (Expires in 5 mins)`, [
                { text: "Copy Key", action: () => navigator.clipboard.writeText(newKey) },
                { text: "Close" }
            ]);
        } catch(e) { showPopup("Error", "Could not generate key.", [{ text: "OK" }]); }
    }
    
    async function checkVerificationKey(inputKey) {
        try {
            const docSnap = await getDoc(doc(db, ADMIN_KEY_DOC_PATH));
            if (!docSnap.exists()) { showPopup("Error", "No active key.", [{ text: "OK" }]); return; }
            const data = docSnap.data();
            if (data.key === inputKey && data.expires > Date.now()) {
                await updateDoc(doc(db, USERS_COLLECTION_PATH, currentUserId), { isVerified: true });
                isDarkVerified = true;
                updateProfileUI();
                showPopup("Success", "You are now Dark Verifiedâ„¢!", [{ text: "Awesome!" }]);
            } else { showPopup("Failed", "Invalid or expired key.", [{ text: "Try Again" }]); }
        } catch (e) { showPopup("Error", "Verification error.", [{ text: "OK" }]); }
    }

    // --- Privacy Sheet Logic ---
    let startY = 0; let isDragging = false;
    function openPrivacySheet() {
        sheetOverlay.classList.add('open'); privacySheet.classList.add('open');
        document.body.style.overflow = 'hidden'; 
    }
    function closePrivacySheet() {
        privacySheet.style.transform = 'translateY(100%)'; sheetOverlay.classList.remove('open');
        setTimeout(() => { privacySheet.classList.remove('open'); privacySheet.style.transform = ''; document.body.style.overflow = ''; }, 300);
    }
    sheetOverlay.addEventListener('click', closePrivacySheet);
    privacyBtn.addEventListener('click', openPrivacySheet);
    privacySheet.addEventListener('touchstart', (e) => {
        const content = document.querySelector('.sheet-content');
        if (content.scrollTop > 0 && !sheetDragArea.contains(e.target)) return;
        startY = e.touches[0].clientY; isDragging = true; privacySheet.style.transition = 'none'; 
    }, { passive: true });
    privacySheet.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        const deltaY = e.touches[0].clientY - startY;
        if (deltaY > 0) { e.preventDefault(); privacySheet.style.transform = `translateY(${deltaY}px)`; }
    }, { passive: false });
    privacySheet.addEventListener('touchend', (e) => {
        if (!isDragging) return; isDragging = false;
        const deltaY = e.changedTouches[0].clientY - startY;
        privacySheet.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
        if (deltaY > 100) closePrivacySheet();
        else privacySheet.style.transform = 'translateY(0)';
    });

    // --- Navigation ---
    function switchPage(page) {
        Object.values(pages).forEach(p => p.classList.add('hidden'));
        pages[page].classList.remove('hidden');
        document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
        const targetBtn = document.getElementById(`${page}Btn`);
        if (targetBtn) targetBtn.classList.add('active');
        if (page === 'profile') updateProfileUI();
        // Cleanup comments listener if leaving viewPost
        if (page !== 'viewPost' && commentsUnsubscribe) {
            commentsUnsubscribe();
            commentsUnsubscribe = null;
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // --- Popup ---
    function showPopup(title, message, buttons = [{ text: "OK" }], showInput = false, inputPlaceholder = '', inputType = 'text', inputId = 'popupInput') {
        popupTitle.textContent = title;
        popupMessage.innerHTML = message.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        popupMessage.style.display = 'block';
        popupButtons.innerHTML = '';
        
        const existingInput = popup.querySelector('input');
        if (existingInput) existingInput.remove();
        
        const inputElement = document.createElement('input');
        inputElement.id = inputId; inputElement.placeholder = inputPlaceholder;
        inputElement.type = inputType; inputElement.style.display = showInput ? 'block' : 'none';
        popup.insertBefore(inputElement, popupButtons);

        popupOverlay.style.display = 'flex';
        const buttonHolder = document.createElement('div');
        const isTwoButtonHorizontal = buttons.length === 2 && buttons.every(btn => btn.text.length < 10);
        buttonHolder.className = 'button-holder ' + (isTwoButtonHorizontal ? 'two-button' : 'vertical-buttons');
        const displayButtons = isTwoButtonHorizontal ? buttons : [...buttons].reverse();

        displayButtons.forEach(btn => {
            const a = document.createElement('a');
            a.textContent = btn.text;
            if (btn.text === "Delete" || btn.text === "Remove") a.classList.add('delete-button');
            else if (btn.text !== "Cancel" && (isTwoButtonHorizontal || btn === displayButtons[displayButtons.length - 1])) a.style.fontWeight = '600';
            a.onclick = () => { 
                const value = showInput ? document.getElementById(inputId).value : null;
                closePopup(); btn.action && btn.action(value); 
            };
            buttonHolder.appendChild(a);
        });
        popupButtons.appendChild(buttonHolder);
    }
    function closePopup() { popupOverlay.style.display = 'none'; }
    popupOverlay.addEventListener('click', e => { if (e.target === popupOverlay) closePopup(); });

    // --- Firebase & Logic ---
    async function initFirebase() {
        setLogLevel('Silent');
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
            else await signInAnonymously(auth);
            currentUserId = auth.currentUser.uid;
            isAuthReady = true;
            await fetchUserProfile();
            startRealtimeListener();
        } catch (error) { console.error("Error init:", error); }
    }
    
    const userCache = {};
    async function getUserDetails(uid) {
        if (userCache[uid]) return userCache[uid];
        try {
            const docSnap = await getDoc(doc(db, USERS_COLLECTION_PATH, uid));
            if (docSnap.exists()) {
                const data = docSnap.data();
                userCache[uid] = { userName: data.userName || 'Dark User', isVerified: data.isVerified || false };
                return userCache[uid];
            }
        } catch (e) { }
        return { userName: 'Dark User', isVerified: false };
    }

    function startRealtimeListener() {
        if (!isAuthReady) return;
        const postsQuery = query(collection(db, POSTS_COLLECTION_PATH));
        onSnapshot(postsQuery, async (snapshot) => {
            const postsArray = [];
            const uidsToFetch = new Set();
            snapshot.docChanges().forEach(change => {
                if (change.type !== "removed" && change.doc.data().ownerId) uidsToFetch.add(change.doc.data().ownerId);
            });
            await Promise.all(Array.from(uidsToFetch).map(uid => getUserDetails(uid)));

            snapshot.forEach(doc => {
                const postData = doc.data();
                const userDetails = userCache[postData.ownerId] || { userName: 'Dark User', isVerified: false };
                const post = {
                    id: doc.id,
                    title: postData.title,
                    content: postData.content,
                    ownerId: postData.ownerId || '',
                    userName: userDetails.userName, 
                    isVerified: userDetails.isVerified, 
                    likes: postData.likes || 0,
                    dislikes: postData.dislikes || 0,
                    reactedBy: postData.reactedBy || {},
                    timestamp: postData.timestamp ? postData.timestamp.toDate() : new Date(),
                };
                postsArray.push(post);
                currentPostsData[post.id] = post; 
            });
            postsArray.sort((a, b) => b.timestamp - a.timestamp);
            displayPosts(postsArray, searchBar.value);
            
            // Refresh current view if open
            if (currentKey && !pages.viewPost.classList.contains('hidden')) {
                if (currentPostsData[currentKey]) openPost(currentKey, currentPostsData[currentKey], false);
                else { switchPage('home'); currentKey = null; }
            }
        });
    }

    postForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthReady) return;
        const title = document.getElementById('title').value.trim();
        const content = document.getElementById('content').value.trim();
        if (title && content) {
            try {
                await addDoc(collection(db, POSTS_COLLECTION_PATH), {
                    title: title, content: content, ownerId: currentUserId, likes: 0, dislikes: 0, reactedBy: {}, timestamp: serverTimestamp() 
                });
                postForm.reset();
                showPopup("Published", "Your post is live!", [{ text: "OK", action: () => switchPage('home') }]);
            } catch (error) { console.error(error); }
        }
    });

    function displayPosts(postsArray, filter = '') {
        postsContainer.innerHTML = '';
        const filtered = postsArray.filter(p => p.title.toLowerCase().includes(filter.toLowerCase()) || p.content.toLowerCase().includes(filter.toLowerCase()));
        if (filtered.length === 0) {
            postsContainer.innerHTML = '<div class="empty-state"><i class="fa-solid fa-cloud-moon"></i><p>No posts found.</p></div>';
            return;
        }
        filtered.forEach(post => {
            const userReaction = post.reactedBy[currentUserId] || 'none';
            const formattedDate = formatTime(post.timestamp);
            const div = document.createElement('div');
            div.className = 'post';
            div.innerHTML = `
                <div class="post-header">
                    <div class="post-avatar">${getInitials(post.userName)}</div>
                    <div class="post-owner-info">${getPostOwnerName(post)}<small>Posted on ${formattedDate}</small></div>
                </div>
                <h2>${post.title}</h2>
                <p class="post-content-preview">${post.content}</p>
                <div class="reaction-bar list-view">
                    <a class="reaction-button ${userReaction === 'like' ? 'liked' : ''}" data-type="like" data-id="${post.id}"><i class="${userReaction === 'like' ? 'fas' : 'far'} fa-heart"></i> ${post.likes}</a>
                    <a class="reaction-button ${userReaction === 'dislike' ? 'disliked' : ''}" data-type="dislike" data-id="${post.id}"><i class="${userReaction === 'dislike' ? 'fas' : 'far'} fa-thumbs-down"></i> ${post.dislikes}</a>
                </div>`;
            div.addEventListener('click', (e) => { if (!e.target.closest('.reaction-button')) openPost(post.id, post); });
            div.querySelectorAll('.reaction-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation(); handleReaction(button.dataset.id, button.dataset.type, currentPostsData[button.dataset.id]);
                });
            });
            postsContainer.appendChild(div);
        });
    }

    async function handleReaction(postId, type, currentData) {
        if (!isAuthReady) return;
        const postRef = doc(db, POSTS_COLLECTION_PATH, postId);
        const currentLikes = currentData.likes || 0;
        const currentDislikes = currentData.dislikes || 0;
        const userReaction = currentData.reactedBy[currentUserId] || 'none';
        let newLikes = currentLikes, newDislikes = currentDislikes, newReactionType = type;

        if (userReaction === type) {
            newReactionType = 'none';
            if (type === 'like') newLikes = Math.max(0, newLikes - 1);
            else if (type === 'dislike') newDislikes = Math.max(0, newDislikes - 1);
        } else {
            if (userReaction === 'like') newLikes = Math.max(0, newLikes - 1);
            else if (userReaction === 'dislike') newDislikes = Math.max(0, newDislikes - 1);
            if (type === 'like') newLikes += 1;
            else if (type === 'dislike') newDislikes += 1;
        }
        await updateDoc(postRef, { likes: newLikes, dislikes: newDislikes, [`reactedBy.${currentUserId}`]: newReactionType });
    }

    // --- COMMENTS LOGIC ---
    
    function loadComments(postId) {
        if (commentsUnsubscribe) commentsUnsubscribe();
        commentsList.innerHTML = '<div style="text-align:center; padding:10px;"><i class="fa-solid fa-spinner fa-spin"></i> Loading comments...</div>';
        
        const q = query(collection(db, COMMENTS_COLLECTION_PATH), where("postId", "==", postId));
        
        commentsUnsubscribe = onSnapshot(q, (snapshot) => {
            const commentsMap = {};
            snapshot.forEach(doc => {
                const data = doc.data();
                commentsMap[doc.id] = {
                    id: doc.id,
                    ...data,
                    timestamp: data.timestamp ? data.timestamp.toDate() : new Date(),
                    replies: []
                };
            });

            // Build Tree
            const rootComments = [];
            Object.values(commentsMap).sort((a,b) => a.timestamp - b.timestamp).forEach(comment => {
                if (comment.parentId && commentsMap[comment.parentId]) {
                    commentsMap[comment.parentId].replies.push(comment);
                } else {
                    rootComments.push(comment);
                }
            });

            renderCommentTree(rootComments);
        });
    }

    function renderCommentTree(nodes, container = commentsList) {
        if (container === commentsList) container.innerHTML = '';
        
        if (nodes.length === 0 && container === commentsList) {
            container.innerHTML = '<div style="color:var(--muted); text-align:center; padding:20px;">No comments yet. Be the first!</div>';
            return;
        }

        nodes.forEach(comment => {
            const nodeDiv = document.createElement('div');
            nodeDiv.style.marginBottom = '10px';
            
            const isOwner = comment.ownerId === currentUserId;
            const userLiked = (comment.likedBy && comment.likedBy.includes(currentUserId));
            const likeCount = comment.likedBy ? comment.likedBy.length : 0;
            const canDelete = isOwner || isAdmin || (currentPostsData[currentKey] && currentPostsData[currentKey].ownerId === currentUserId);

            // Verified check for comment author
            const badgeHtml = comment.isVerified ? `<img src="${VERIFIED_BADGE_URL}" class="verified-badge" title="Dark Verifiedâ„¢">` : '';

            const commentHtml = `
                <div class="comment-node" id="comment-${comment.id}">
                    <div class="comment-header">
                        <div class="comment-author">${comment.userName}${badgeHtml}</div>
                        <div class="comment-time">${formatTime(comment.timestamp)}</div>
                    </div>
                    <div class="comment-body">${comment.content}</div>
                    <div class="comment-actions">
                        <div class="comment-action-btn ${userLiked ? 'liked' : ''}" onclick="window.toggleCommentLike('${comment.id}')">
                            <i class="${userLiked ? 'fa-solid' : 'fa-regular'} fa-heart"></i> ${likeCount || ''}
                        </div>
                        <div class="comment-action-btn" onclick="window.showReplyForm('${comment.id}')">
                            <i class="fa-solid fa-reply"></i> Reply
                        </div>
                        ${canDelete ? `<div class="comment-action-btn" style="color:var(--red-delete);" onclick="window.deleteComment('${comment.id}')"><i class="fa-solid fa-trash"></i></div>` : ''}
                    </div>
                    <div id="reply-form-${comment.id}" class="reply-form hidden">
                        <input type="text" placeholder="Write a reply..." id="reply-input-${comment.id}" style="flex:1;">
                        <button onclick="window.submitReply('${comment.id}')">Send</button>
                    </div>
                </div>
                <div class="replies-container" id="replies-${comment.id}"></div>
            `;
            
            nodeDiv.innerHTML = commentHtml;
            container.appendChild(nodeDiv);
            
            // Recursive Render
            if (comment.replies.length > 0) {
                renderCommentTree(comment.replies, nodeDiv.querySelector(`#replies-${comment.id}`));
            }
        });
    }

    // --- Global Comment Functions (Attached to Window for HTML access) ---
    
    window.addComment = async () => {
        const text = addCommentInput.value.trim();
        if (!text) return;
        addCommentInput.value = '';
        try {
            await addDoc(collection(db, COMMENTS_COLLECTION_PATH), {
                postId: currentKey, parentId: null, content: text,
                ownerId: currentUserId, userName: currentUserName, isVerified: isDarkVerified,
                timestamp: serverTimestamp(), likedBy: []
            });
        } catch (e) { console.error(e); }
    };
    addCommentBtn.onclick = window.addComment;

    window.showReplyForm = (id) => {
        const form = document.getElementById(`reply-form-${id}`);
        form.classList.toggle('hidden');
        if(!form.classList.contains('hidden')) document.getElementById(`reply-input-${id}`).focus();
    };

    window.submitReply = async (parentId) => {
        const input = document.getElementById(`reply-input-${parentId}`);
        const text = input.value.trim();
        if (!text) return;
        input.value = '';
        document.getElementById(`reply-form-${parentId}`).classList.add('hidden');
        
        try {
            await addDoc(collection(db, COMMENTS_COLLECTION_PATH), {
                postId: currentKey, parentId: parentId, content: text,
                ownerId: currentUserId, userName: currentUserName, isVerified: isDarkVerified,
                timestamp: serverTimestamp(), likedBy: []
            });
        } catch (e) { console.error(e); }
    };

    window.toggleCommentLike = async (commentId) => {
        if (!isAuthReady) return;
        const ref = doc(db, COMMENTS_COLLECTION_PATH, commentId);
        try {
            const snap = await getDoc(ref);
            if (snap.exists()) {
                const data = snap.data();
                let likes = data.likedBy || [];
                if (likes.includes(currentUserId)) likes = likes.filter(id => id !== currentUserId);
                else likes.push(currentUserId);
                await updateDoc(ref, { likedBy: likes });
            }
        } catch(e) { console.error(e); }
    };

    // Recursive Cascading Delete
    window.deleteComment = (commentId) => {
        showPopup("Delete Comment", "This will delete this comment and all its replies.", [
            { text: "Cancel" },
            { text: "Delete", action: async () => {
                await performRecursiveDelete(commentId);
            }}
        ]);
    };

    async function performRecursiveDelete(targetId) {
        // 1. Fetch all comments for this post to build tree
        const q = query(collection(db, COMMENTS_COLLECTION_PATH), where("postId", "==", currentKey));
        const snapshot = await getDocs(q); // Need getDocs here, not imported yet
        const allComments = [];
        snapshot.forEach(d => allComments.push({id: d.id, parentId: d.data().parentId}));
        
        // 2. Find all descendants
        const idsToDelete = new Set([targetId]);
        let added;
        do {
            added = false;
            allComments.forEach(c => {
                if (!idsToDelete.has(c.id) && idsToDelete.has(c.parentId)) {
                    idsToDelete.add(c.id);
                    added = true;
                }
            });
        } while (added);

        // 3. Batch Delete
        const batch = writeBatch(db);
        idsToDelete.forEach(id => {
            batch.delete(doc(db, COMMENTS_COLLECTION_PATH, id));
        });
        await batch.commit();
    }

    // --- Post View Logic ---
    function openPost(key, post, reload = true) {
        currentKey = key;
        const canDelete = post.ownerId === currentUserId || isAdmin; 
        const formattedDate = formatTime(post.timestamp);
        const userReaction = post.reactedBy[currentUserId] || 'none';

        viewPost.innerHTML = `<div class="view-title">${post.title}</div><small>Posted by ${getPostOwnerName(post)} on ${formattedDate}</small><div class="view-content">${post.content}</div>`;
        
        actionRow.innerHTML = '';
        if (canDelete) {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn-delete';
            deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i> Delete Post';
            deleteBtn.onclick = () => {
                 showPopup("Delete Post", "Are you sure?", [{ text: "Cancel" }, { text: "Delete", action: async () => { 
                    await deleteDoc(doc(db, POSTS_COLLECTION_PATH, currentKey)); switchPage('home'); 
                }}]);
            };
            actionRow.appendChild(deleteBtn);
        }

        detailReactionsContainer.innerHTML = `
            <a class="reaction-button ${userReaction === 'like' ? 'liked' : ''}" data-type="like" data-id="${post.id}" style="font-size: 1.1rem; gap: 8px;"><i class="${userReaction === 'like' ? 'fas' : 'far'} fa-heart"></i><span>${post.likes} Likes</span></a>
            <a class="reaction-button ${userReaction === 'dislike' ? 'disliked' : ''}" data-type="dislike" data-id="${post.id}" style="font-size: 1.1rem; gap: 8px;"><i class="${userReaction === 'dislike' ? 'fas' : 'far'} fa-thumbs-down"></i><span>${post.dislikes} Dislikes</span></a>`;
        
        postOwnerInfo.textContent = `User ID: ${post.ownerId.substr(0,5)}... ${isAdmin ? '(Admin View)' : ''}`;

        detailReactionsContainer.querySelectorAll('.reaction-button').forEach(button => {
            button.addEventListener('click', (e) => { e.stopPropagation(); handleReaction(post.id, button.dataset.type, currentPostsData[post.id]); });
        });
        
        if (reload) {
            switchPage('viewPost');
            loadComments(key);
        }
    }

    // --- Profile Handlers ---
    changeNameBtn.onclick = () => showPopup("Change Name", "New display name:", [{ text: "Cancel" }, { text: "Save", action: (val) => { if(val) updateUserName(val); }}], true, currentUserName);
    
    verifyBtn.onclick = () => {
        if (isDarkVerified) { showPopup("Verified", "You are already verified!", [{ text: "OK" }]); return; }
        showPopup("Verify", "Enter Key:", [{ text: "Cancel" }, { text: "Verify", action: (val) => { if(val) checkVerificationKey(val); }}], true);
    };
    
    adminAccessBtn.onclick = () => showPopup("Admin", "Master Key:", [{ text: "Cancel" }, { text: "Submit", action: async (val) => {
        if (val === ADMIN_PASSKEY) {
            await updateDoc(doc(db, USERS_COLLECTION_PATH, currentUserId), { isAdmin: true });
            isAdmin = true; updateProfileUI(); showPopup("Success", "Admin Unlocked", [{ text: "OK" }]);
        } else showPopup("Error", "Invalid Key", [{ text: "OK" }]);
    }}], true, 'Master Key', 'password');
    
    generateKeyBtn.onclick = saveVerificationKey;

    homeBtn.onclick = () => switchPage('home');
    newBtn.onclick = () => switchPage('newPost');
    profileBtn.onclick = () => switchPage('profile');
    searchBar.oninput = (e) => displayPosts(Object.values(currentPostsData), e.target.value);
    
    initFirebase();
    switchPage('home');
  </script>
</body>
</html>
